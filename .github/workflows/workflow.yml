name: Deployment Prod

on: [push]

jobs:
  Lint:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff Lint
        run: ruff check .

  Test:
    if: github.ref == 'refs/heads/main'
    needs: Lint
    uses: algnot/amara-testing/.github/workflows/trigger-test.yml@main
    with:
      commit_sha: ${{ github.sha }}
    secrets: inherit

  Build:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: Test

    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t ghcr.io/algnot/amara-backend:${{ github.sha }} .

      - name: Login to GHCR
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push image
        run: |
          docker push ghcr.io/algnot/amara-backend:${{ github.sha }}

      - name: Tag latest
        run: |
          docker tag ghcr.io/algnot/amara-backend:${{ github.sha }} ghcr.io/algnot/amara-backend:latest
          docker push ghcr.io/algnot/amara-backend:latest

  Deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: Build

    steps:
      - uses: actions/checkout@v4

      - name: Render manifests
        run: |
          set -e
          TAG=${{ github.sha }}
          HOST=amara-api.tongla.dev
          NS=tongla
          mkdir -p .rendered
          sed "s|__TAG__|${TAG}|g; s|__NS__|${NS}|g; s|__HOST__|${HOST}|g" k8s/app.yaml > .rendered/app.yaml
          sed "s|__TAG__|${TAG}|g; s|__NS__|${NS}|g; s|__HOST__|${HOST}|g" k8s/job.yaml > .rendered/job.yaml
          sed "s|__TAG__|${TAG}|g; s|__NS__|${NS}|g; s|__HOST__|${HOST}|g" k8s/ingress.yaml > .rendered/ingress.yaml

      - name: Encode manifests as base64
        run: |
          set -e
          echo "APP_YAML_B64=$(base64 -w0 .rendered/app.yaml)" >> $GITHUB_ENV
          echo "MIGRATE_YAML_B64=$(base64 -w0 .rendered/job.yaml)" >> $GITHUB_ENV
          echo "INGRESS_YAML_B64=$(base64 -w0 .rendered/ingress.yaml)" >> $GITHUB_ENV

      - name: Apply to microk8s
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          command_timeout: 30m
          envs: APP_YAML_B64,MIGRATE_YAML_B64,INGRESS_YAML_B64
          script: |
            set -e
            TAG=${{ github.sha }}
            
            echo "$MIGRATE_YAML_B64" | base64 -d > /tmp/amara-prod-job.yaml
            echo "$APP_YAML_B64" | base64 -d > /tmp/amara-prod-app.yaml
            echo "$INGRESS_YAML_B64" | base64 -d > /tmp/amara-prod-ingress.yaml
            
            wc -c /tmp/amara-prod-job.yaml /tmp/amara-prod-app.yaml /tmp/amara-prod-ingress.yaml
            head -n 5 /tmp/amara-prod-job.yaml
            head -n 5 /tmp/amara-prod-app.yaml
            head -n 5 /tmp/amara-prod-ingress.yaml
            
            microk8s kubectl apply -f /tmp/amara-prod-job.yaml
            microk8s kubectl -n tongla wait --for=condition=complete job/amara-migrate-${TAG} --timeout=20m

            microk8s kubectl apply -f /tmp/amara-prod-app.yaml
            microk8s kubectl -n tongla rollout status deployment/amara-backend --timeout=5m

            microk8s kubectl apply -f /tmp/amara-prod-ingress.yaml
            microk8s kubectl -n tongla describe ingress amara-backend
